<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Timesheet System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for time inputs */
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(40%) sepia(93%) saturate(2000%) hue-rotate(190deg) brightness(80%) contrast(100%);
        }
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .clickable-row:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-start justify-center min-h-screen p-4 sm:p-8 font-sans">

    <div id="app-container" class="w-full max-w-4xl pt-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700">Staff Time Sheet System</h1>
            <p id="sub-header" class="text-gray-500 mt-2">Log in to track your weekly hours.</p>
        </header>

        <!-- Main Content Area (Login or Timesheet) -->
        <main id="content-area"></main>
    </div>

    <script>
        // --- DATA SIMULATION: Using localStorage for stable data persistence ---
        
        const localStorageKey = (employeeId, weekStart) => `timesheet_${employeeId}_${weekStart}`;
        const employeeDataKey = 'employee_contracts';

        // Helper function to extract the last name from the full name
        function extractSurname(fullName) {
            if (!fullName) return '';
            const parts = fullName.split(' ');
            return parts[parts.length - 1].toUpperCase();
        }

        // Initial setup for demo employees in localStorage (Admin data)
        function getEmployeeContracts() {
            const data = localStorage.getItem(employeeDataKey);
            const contracts = data ? JSON.parse(data) : {
                // NOTE: Surname is derived from the name property for login validation
                'A9999': { name: 'Administrator', contractHours: 0.0 },
                'E1001': { name: 'Debbie Abbott', contractHours: 12.5 },
                'E1002': { name: 'Lorna Keeping', contractHours: 20.0 },
                'E1003': { name: 'Joy Davies', contractHours: 0.0 }
            };
            
            // Add derived surname for easy lookup
            for (const id in contracts) {
                contracts[id].surname = extractSurname(contracts[id].name);
            }
            return contracts;
        }

        function saveEmployeeContracts(contracts) {
            localStorage.setItem(employeeDataKey, JSON.stringify(contracts));
        }

        // Initialize demo data if not present
        if (!localStorage.getItem(employeeDataKey)) {
            saveEmployeeContracts(getEmployeeContracts());
        }

        let currentEmployee = null; // Holds the logged-in employee data
        let currentWeekStart = null; // Date object for the Monday start of the current week
        
        // --- CORE APPLICATION LOGIC ---

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust day to Monday (1)
            const monday = new Date(d.setDate(diff));
            
            // Set time to 00:00:00 to represent the very start of Monday
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function formatWeekStart(date) {
            return date.toISOString().split('T')[0]; // YYYY-MM-DD for storage
        }
        
        function calculateTimeDifference(start, end) {
            if (!start || !end) return 0;
            
            const [startHour, startMin] = start.split(':').map(Number);
            const [endHour, endMin] = end.split(':').map(Number);
            
            // Convert to minutes
            const startTimeMinutes = startHour * 60 + startMin;
            const endTimeMinutes = endHour * 60 + endMin;
            
            if (endTimeMinutes <= startTimeMinutes) return 0; // Invalid entry
            
            const diffMinutes = endTimeMinutes - startTimeMinutes;
            return diffMinutes / 60; // Convert to hours
        }

        function calculateTotals(timesheetData, contractHours) {
            let totalSubmittedHours = 0;
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Create a temporary data structure if timesheetData is null/empty for a new week
            const currentTimesheet = timesheetData || days.reduce((acc, day) => {
                acc[day] = { amStart: '', amEnd: '', pmStart: '', pmEnd: '', dailyTotal: '0.00' };
                return acc;
            }, {});

            for (const day of days) {
                const dayEntry = currentTimesheet[day] || {};
                
                const amHours = calculateTimeDifference(dayEntry.amStart, dayEntry.amEnd);
                const pmHours = calculateTimeDifference(dayEntry.pmStart, dayEntry.pmEnd);
                
                currentTimesheet[day].dailyTotal = (amHours + pmHours).toFixed(2);
                totalSubmittedHours += amHours + pmHours;
            }
            
            const totalSubmitted = parseFloat(totalSubmittedHours.toFixed(2));
            const totalPaid = Math.max(totalSubmitted, contractHours);
            
            return { 
                timesheet: currentTimesheet, 
                totalSubmitted, 
                totalPaid 
            };
        }
        
        function loadTimesheet(employeeId) {
            const today = new Date();
            currentWeekStart = getWeekStart(today);
            const weekStartString = formatWeekStart(currentWeekStart);

            const storedDataRaw = localStorage.getItem(localStorageKey(employeeId, weekStartString));
            
            let timesheetData = storedDataRaw ? JSON.parse(storedDataRaw) : null;
            
            // Get contract hours
            const contracts = getEmployeeContracts();
            const contractHours = contracts[employeeId]?.contractHours || 0;
            
            // Calculate and get the structured data back
            const calculationResult = calculateTotals(timesheetData, contractHours);
            
            return { 
                employeeId, 
                weekStartString, 
                timesheet: calculationResult.timesheet,
                totalSubmitted: calculationResult.totalSubmitted,
                totalPaid: calculationResult.totalPaid,
                isSubmitted: timesheetData ? (timesheetData.isSubmitted || false) : false
            };
        }
        
        function saveTimesheet(data) {
            const weekStartString = formatWeekStart(currentWeekStart);
            localStorage.setItem(localStorageKey(data.employeeId, weekStartString), JSON.stringify({
                isSubmitted: data.isSubmitted,
                ...data.timesheet
            }));
            // Only re-render staff view, admin view needs explicit refresh/update
            if (currentEmployee.employeeId !== 'A9999') {
                renderTimesheetView(data);
            }
        }

        // Function to get all timesheet summaries for the current week
        function getAllTimesheetSummaries() {
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            const weekStartString = formatWeekStart(currentWeekStart);
            const contracts = getEmployeeContracts();
            const summaries = [];
            
            // Iterate over all employees (excluding the Admin itself)
            for (const employeeId in contracts) {
                if (employeeId === 'A9999') continue;
                
                const employee = contracts[employeeId];
                const contractHours = employee.contractHours;
                
                const storedDataRaw = localStorage.getItem(localStorageKey(employeeId, weekStartString));
                let timesheetData = storedDataRaw ? JSON.parse(storedDataRaw) : null;

                const { totalSubmitted, totalPaid } = calculateTotals(timesheetData, contractHours);
                const isSubmitted = timesheetData ? (timesheetData.isSubmitted || false) : false;

                summaries.push({
                    employeeId,
                    name: employee.name,
                    contractHours,
                    totalSubmitted: totalSubmitted,
                    totalPaid: totalPaid,
                    isSubmitted: isSubmitted
                });
            }
            return summaries;
        }

        // --- RENDER FUNCTIONS ---
        
        function renderLoginView() {
            document.getElementById('sub-header').textContent = 'Please enter your Staff Number and Last Name to access your timesheet.';
            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-full max-w-md bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
                        <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-2">Staff Number (or Employee ID)</label>
                        <input 
                            type="text" 
                            id="employeeId" 
                            placeholder="S12345"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base mb-4 uppercase"
                        >
                        
                        <label for="surname" class="block text-sm font-medium text-gray-700 mb-2">Last Name (for verification)</label>
                        <input 
                            type="text" 
                            id="surname" 
                            placeholder="Smith"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base mb-4"
                        >

                        <button 
                            id="loginButton"
                            class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-lg transition duration-300 ease-in-out bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300"
                        >
                            Access Timesheet
                        </button>
                        
                        <p id="message-box" class="text-center mt-4 text-sm text-red-600 hidden"></p>
                    </div>
                </div>
            `;
            
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            
            // Handle Enter key for both inputs
            document.getElementById('employeeId').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('surname').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        
        function updateMessage(text, isError = true) {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.textContent = text;
                messageBox.className = `text-center mt-4 text-sm ${isError ? 'text-red-600' : 'text-green-600'} visible`;
            }
        }

        function renderAdminView() {
            currentWeekStart = getWeekStart(new Date());
            document.getElementById('sub-header').textContent = `Administrator Portal - Week Starting: ${formatWeekStart(currentWeekStart)}`;
            const content = document.getElementById('content-area');
            const contracts = getEmployeeContracts();
            const summaries = getAllTimesheetSummaries();

            const summaryRowHtml = summaries.map(s => {
                const statusClass = s.isSubmitted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = s.isSubmitted ? 'Submitted' : 'In Progress';

                return `
                    <tr class="border-t clickable-row" data-employee-id="${s.employeeId}">
                        <td class="px-4 py-3 font-semibold text-gray-800 flex items-center">
                            <span class="underline hover:text-blue-600 cursor-pointer">${s.employeeId} - ${s.name}</span>
                        </td>
                        <td class="px-4 py-3 text-center">${s.contractHours}</td>
                        <td class="px-4 py-3 text-center text-blue-700 font-bold">${s.totalSubmitted}</td>
                        <td class="px-4 py-3 text-center text-green-700 font-bold">${s.totalPaid}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const userListHtml = Object.entries(contracts).filter(([id]) => id !== 'A9999').map(([id, data]) => `
                <li class="p-3 border-b border-gray-100 flex justify-between items-center text-sm">
                    <span class="font-semibold text-gray-800">${id} - ${data.name}</span>
                    <span class="text-blue-600">${data.contractHours} hrs/wk</span>
                    <div class="flex items-center space-x-3">
                        <button data-id="${id}" class="edit-btn text-xs text-blue-500 hover:text-blue-700 font-medium">Edit</button>
                        <button data-id="${id}" class="delete-btn text-xs text-red-500 hover:text-red-700 font-medium">Delete</button>
                    </div>
                </li>
            `).join('');


            content.innerHTML = `
                <div class="flex flex-col gap-8">
                    
                    <!-- Weekly Timesheet Summary Dashboard -->
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Weekly Timesheet Summary</h2>
                        <div class="overflow-x-auto mb-4">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Employee (Click to View)</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Contract (Hrs)</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Submitted (Hrs)</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Paid (Hrs)</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-summary-body" class="divide-y divide-gray-200">
                                    ${summaryRowHtml.length > 0 ? summaryRowHtml : `
                                        <tr><td colspan="5" class="text-center py-6 text-gray-500">No employee data found for this week.</td></tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- DETAIL VIEW SECTION (Appears when employee name is clicked) -->
                        <div id="admin-detail-view" class="mt-6 border-t pt-6 hidden"></div>
                    </div>

                    <!-- Management Forms -->
                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- User Management Form -->
                        <div class="lg:w-1/3 bg-white p-6 rounded-xl shadow-md border border-gray-100 h-fit">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Add / Edit Employee</h2>
                            <input type="text" id="admin_id" placeholder="Employee ID (E1001)" class="w-full p-2 border rounded mb-3 uppercase">
                            <input type="text" id="admin_name" placeholder="Full Name (e.g. Alice Johnson)" class="w-full p-2 border rounded mb-3">
                            <input type="number" id="admin_hours" placeholder="Contract Hours (0.0 or 12.5)" step="0.5" class="w-full p-2 border rounded mb-4">
                            <button id="saveAdminButton" class="w-full py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition">Add/Update Employee</button>
                        </div>

                        <!-- Current Users List -->
                        <div class="lg:w-2/3 bg-white p-6 rounded-xl shadow-md border border-gray-100">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Current System Users</h2>
                            <ul id="admin-user-list" class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                                ${userListHtml.length > 0 ? userListHtml : '<li class="p-3 text-gray-500">No employees defined yet.</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <button id="logoutButton" class="w-full py-3 mt-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition max-w-xs self-center">Log Out</button>

                </div>
            `;
            
            // Attach event listeners for Admin View
            document.getElementById('saveAdminButton').addEventListener('click', handleSaveEmployee);
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            
            // Click handler for viewing employee details
            document.querySelectorAll('#admin-summary-body .clickable-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    const employeeId = row.getAttribute('data-employee-id');
                    handleViewDetails(employeeId);
                });
            });
            
            // Edit button handler
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const emp = contracts[id];
                    document.getElementById('admin_id').value = id;
                    document.getElementById('admin_name').value = emp.name;
                    document.getElementById('admin_hours').value = emp.contractHours;
                });
            });

            // NEW: Delete button handler
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    handleDeleteEmployee(id);
                });
            });
        }
        
        // New function to render the detailed timesheet view within the Admin Dashboard
        function renderAdminDetailsView(employeeId, data) {
            const detailView = document.getElementById('admin-detail-view');
            const employee = getEmployeeContracts()[employeeId];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const rowHtml = days.map(day => {
                const dayData = data.timesheet[day];
                const dayClass = day === 'Saturday' || day === 'Sunday' ? 'bg-yellow-50' : 'bg-white';
                
                return `
                    <tr class="border-t ${dayClass}">
                        <td class="px-4 py-3 font-semibold text-gray-800">${day}</td>
                        <td class="p-1 text-center">${dayData.amStart || '-'}</td>
                        <td class="p-1 text-center">${dayData.amEnd || '-'}</td>
                        <td class="p-1 text-center">${dayData.pmStart || '-'}</td>
                        <td class="p-1 text-center">${dayData.pmEnd || '-'}</td>
                        <td class="px-4 py-3 font-bold text-center">${dayData.dailyTotal}</td>
                    </tr>
                `;
            }).join('');

            detailView.innerHTML = `
                <h3 class="xl font-bold mb-3 text-gray-800">Detailed Entries for: ${employee.name} (${employeeId})</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Day</th>
                                <th colspan="2" class="text-center py-3 text-xs font-bold text-gray-600 uppercase tracking-wider border-x">AM (Start - End)</th>
                                <th colspan="2" class="text-center py-3 text-xs font-bold text-gray-600 uppercase tracking-wider border-x">PM (Start - End)</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Daily Total (hrs)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rowHtml}
                        </tbody>
                        <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                            <tr>
                                <td colspan="5" class="px-4 py-3 text-right font-bold text-gray-800">Weekly Total Submitted:</td>
                                <td class="px-4 py-3 text-center font-extrabold text-blue-700">${data.totalSubmitted.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            detailView.classList.remove('hidden');
        }

        function handleViewDetails(employeeId) {
            const timesheetData = loadTimesheet(employeeId);
            renderAdminDetailsView(employeeId, timesheetData);
        }

        function renderTimesheetView(data) {
            const employee = getEmployeeContracts()[data.employeeId];
            const contractHours = employee.contractHours;
            const isSubmitted = data.isSubmitted;
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            document.getElementById('sub-header').innerHTML = `
                <span class="font-bold text-gray-700">${employee.name}</span> | Week Starting: ${data.weekStartString} | Contract: <span class="text-blue-600 font-semibold">${contractHours} hours</span>
            `;

            const rowHtml = days.map(day => {
                const dayData = data.timesheet[day];
                const readOnly = isSubmitted ? 'readonly' : '';
                const dayClass = day === 'Saturday' || day === 'Sunday' ? 'bg-yellow-50' : 'bg-white';
                
                return `
                    <tr class="border-t ${dayClass}">
                        <td class="px-4 py-3 font-semibold text-gray-800">${day}</td>
                        
                        <td class="p-1"><input type="time" data-day="${day}" data-type="amStart" value="${dayData.amStart}" ${readOnly} class="time-input w-full p-2 border rounded text-sm text-center"></td>
                        <td class="p-1"><input type="time" data-day="${day}" data-type="amEnd" value="${dayData.amEnd}" ${readOnly} class="time-input w-full p-2 border rounded text-sm text-center"></td>
                        
                        <td class="p-1"><input type="time" data-day="${day}" data-type="pmStart" value="${dayData.pmStart}" ${readOnly} class="time-input w-full p-2 border rounded text-sm text-center"></td>
                        <td class="p-1"><input type="time" data-day="${day}" data-type="pmEnd" value="${dayData.pmEnd}" ${readOnly} class="time-input w-full p-2 border rounded text-sm text-center"></td>
                        
                        <td class="px-4 py-3 font-bold text-center">${dayData.dailyTotal}</td>
                    </tr>
                `;
            }).join('');
            
            const submitButtonHtml = isSubmitted ? `
                <div class="flex items-center space-x-4">
                    <span class="text-lg font-bold text-green-600">âœ… Submitted!</span>
                    <button id="recallButton" class="py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition">Recall Submission</button>
                </div>
            ` : `
                <button id="submitButton" class="py-3 px-8 bg-blue-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-blue-600 transition focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Submit Final Hours
                </button>
            `;

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="flex flex-col space-y-8">
                    
                    <!-- Timesheet Table -->
                    <div class="bg-white rounded-xl shadow-2xl overflow-x-auto border border-gray-100">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Day</th>
                                    <th colspan="2" class="text-center py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-x">AM (Start - End)</th>
                                    <th colspan="2" class="text-center py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-x">PM (Start - End)</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Daily Total (hrs)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${rowHtml}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer / Summary / Action -->
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                        
                        <!-- Summary -->
                        <div class="space-y-2 text-sm md:text-base">
                            <p><span class="font-bold text-gray-700">Total Submitted Hours:</span> <span class="text-blue-700 font-extrabold text-xl">${data.totalSubmitted.toFixed(2)}</span> hrs</p>
                            <p><span class="font-bold text-gray-700">Total Paid Hours:</span> <span class="text-green-700 font-extrabold text-xl">${data.totalPaid.toFixed(2)}</span> hrs (Max(Submitted, Contract))</p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex flex-col items-center space-y-3">
                            ${submitButtonHtml}
                            <button id="logoutButton" class="py-1 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition">Log Out</button>
                        </div>
                    </div>
                </div>
            `;

            // Attach event listeners
            document.querySelectorAll('.time-input').forEach(input => {
                // The 'change' event fires when the input loses focus, providing the auto-save functionality
                input.addEventListener('change', (e) => handleTimeInput(e, data));
            });
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            
            if (document.getElementById('submitButton')) {
                document.getElementById('submitButton').addEventListener('click', () => handleSubmit(data));
            }
            if (document.getElementById('recallButton')) {
                document.getElementById('recallButton').addEventListener('click', () => handleRecall(data));
            }
        }

        // --- HANDLERS ---

        function handleTimeInput(e, data) {
            const input = e.target;
            const day = input.getAttribute('data-day');
            const type = input.getAttribute('data-type');
            const value = input.value;
            
            // 1. Update the local timesheet data structure
            data.timesheet[day][type] = value;
            
            // 2. Recalculate totals
            const contracts = getEmployeeContracts();
            const contractHours = contracts[data.employeeId]?.contractHours || 0;
            const calculationResult = calculateTotals(data.timesheet, contractHours);
            data.timesheet = calculationResult.timesheet;
            data.totalSubmitted = calculationResult.totalSubmitted;
            data.totalPaid = calculationResult.totalPaid;
            
            // 3. Save and re-render the view (auto-save!)
            saveTimesheet(data);
        }

        function handleLogin() {
            const employeeIdInput = document.getElementById('employeeId');
            const surnameInput = document.getElementById('surname');
            
            const employeeId = employeeIdInput.value.trim().toUpperCase();
            const inputSurname = surnameInput.value.trim().toUpperCase();
            
            const contracts = getEmployeeContracts();
            
            updateMessage('', false); // Clear previous messages

            if (!employeeId || !inputSurname) {
                updateMessage('Please enter both your Staff Number and Last Name.', true);
                return;
            }

            const employee = contracts[employeeId];

            if (!employee) {
                updateMessage(`Login failed: Staff Number "${employeeId}" not found in system.`, true);
                return;
            }

            // --- SURNAME VALIDATION ---
            // If the surname from the input does NOT match the extracted surname from the employee record, reject login.
            if (employee.surname !== inputSurname) {
                 updateMessage(`Login failed: Staff Number and Last Name combination is incorrect.`, true);
                return;
            }
            // --- END VALIDATION ---


            // Assign the logged-in employee details
            currentEmployee = { name: employee.name, employeeId: employeeId };
            
            if (employeeId === 'A9999') {
                renderAdminView();
            } else {
                const timesheetData = loadTimesheet(employeeId);
                renderTimesheetView(timesheetData);
            }
        }

        function handleLogout() {
            currentEmployee = null;
            currentWeekStart = null;
            renderLoginView();
        }

        function handleSaveEmployee() {
            const id = document.getElementById('admin_id').value.trim().toUpperCase();
            const name = document.getElementById('admin_name').value.trim();
            const hours = parseFloat(document.getElementById('admin_hours').value);

            if (!id || !name || isNaN(hours)) {
                alert("Please fill in a valid ID, Name (including a surname), and Contract Hours.");
                return;
            }
            
            if (id === 'A9999') {
                 alert("Cannot edit the Admin account details.");
                return;
            }

            const contracts = getEmployeeContracts();
            // Important: We save the new employee with their calculated surname
            contracts[id] = { 
                name: name, 
                contractHours: hours,
                surname: extractSurname(name) // Calculate and store surname immediately
            };
            saveEmployeeContracts(contracts);

            alert(`Employee ${id} (${name}) saved with ${hours} contract hours. Surname for login is: ${extractSurname(name)}.`);
            renderAdminView(); // Re-render the list and dashboard
        }
        
        function handleDeleteEmployee(employeeId) {
            if (employeeId === 'A9999') {
                alert("Cannot delete the Administrator account.");
                return;
            }

            // Confirmation Dialog (as requested)
            if (confirm(`Are you sure you want to permanently DELETE employee ${employeeId}? This action cannot be undone and will delete their contract data.`)) {
                
                const contracts = getEmployeeContracts();
                
                // Check if the employee still exists before attempting deletion
                if (!contracts[employeeId]) {
                    alert(`Error: Employee ${employeeId} not found.`);
                    renderAdminView(); // Re-render in case of display error
                    return;
                }

                // Delete the employee contract
                delete contracts[employeeId];
                saveEmployeeContracts(contracts);

                // Optional cleanup: remove timesheet data for the current week
                const today = new Date();
                const weekStartString = formatWeekStart(getWeekStart(today));
                localStorage.removeItem(localStorageKey(employeeId, weekStartString));
                
                alert(`Employee ${employeeId} has been successfully deleted.`);
                renderAdminView(); // Re-render the dashboard and list
            }
            // If the user cancels the 'confirm' dialog, nothing happens.
        }

        function handleSubmit(data) {
            if (!confirm(`Are you sure you want to SUBMIT the timesheet for ${data.totalSubmitted.toFixed(2)} hours? This will lock the entries.`)) {
                return;
            }
            
            // 1. Mark as submitted in the data structure
            data.isSubmitted = true;
            saveTimesheet(data);

            // 2. Generate and trigger email
            const contracts = getEmployeeContracts();
            const employee = contracts[data.employeeId];
            const recipient = 'timesheet_admin@yourcompany.com';
            const subject = `TIMESHEET SUBMISSION: ${employee.name} - Week of ${data.weekStartString}`;
            
            let body = `Employee: ${employee.name} (${data.employeeId})\n`;
            body += `Contract Hours: ${employee.contractHours} hrs\n`;
            body += `\n--- FINAL HOURS ---\n`;
            body += `Total Submitted: ${data.totalSubmitted.toFixed(2)} hrs\n`;
            body += `Total PAID: ${data.totalPaid.toFixed(2)} hrs\n`;
            body += `\n--- DAILY BREAKDOWN ---\n`;
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            days.forEach(day => {
                const dayData = data.timesheet[day];
                body += `${day}: ${dayData.amStart || ''}-${dayData.amEnd || ''} | ${dayData.pmStart || ''}-${dayData.pmEnd || ''} (${dayData.dailyTotal} hrs)\n`;
            });

            // Use the safest way to trigger mailto link
            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        function handleRecall(data) {
            if (confirm("Are you sure you want to recall this submitted timesheet? This will unlock the sheet for editing.")) {
                data.isSubmitted = false;
                saveTimesheet(data);
                renderTimesheetView(data);
            }
        }

        // --- APPLICATION START ---
        
        renderLoginView();
    </script>
</body>
</html>
