<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Timesheet System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <!-- Content will be rendered here -->
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";
        
        // Setting Debug log level for robust testing
        setLogLevel('Debug');

        // --- GLOBAL STATE & CONFIGURATION ---
        let db = null;
        let auth = null;
        let currentUserId = null;
        let currentEmployee = null;
        let isAppReady = false;
        
        // MANDATORY: The application ID provided by the environment
        const appId = 'timesheet-app'; 

        // --- FIREBASE CONFIGURATION (START) ---
        // !!! IMPORTANT !!!
        // You MUST replace the next two lines with your actual firebaseConfig object
        // from your Firebase Project Settings. E.g., const firebaseConfig = { apiKey: "...", ... };
        const firebaseConfig = {
            apiKey: "AIzaSyB3pPhsuruFwVxu5nFg08g4GFYNNRCFDZw",
            authDomain: "timesheet-test-18350.firebaseapp.com",
            projectId: "timesheet-test-18350",
            storageBucket: "timesheet-test-18350.firebasestorage.app",
            messagingSenderId: "97086458609",
            appId: "1:97086458609:web:dcf54891bc1f4aaed6f750"
        };
        const initialAuthToken = null;
        // --- FIREBASE CONFIGURATION (END) ---

        // Time Sheet Logic Constants
        const MILLISECONDS_IN_HOUR = 3600000;
        const MILLISECONDS_IN_MINUTE = 60000;
        const DAYS_OF_WEEK = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        // --- AUTHENTICATION & INITIALIZATION ---

        const calculateStartOfWeek = (d) => {
            d = new Date(d);
            const day = d.getDay(); // 0 = Sunday, 1 = Monday
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            const startOfWeek = new Date(d.setDate(diff));
            
            // Set to 00:00:00.000 Monday morning
            startOfWeek.setHours(0, 0, 0, 0); 
            return startOfWeek;
        };
        
        const getWeekId = () => {
            const startOfWeek = calculateStartOfWeek(new Date());
            return startOfWeek.toISOString().slice(0, 10); // YYYY-MM-DD format
        };
        
        // --- UTILITY FUNCTIONS ---

        const formatTime = (minutes) => {
            if (minutes === null || isNaN(minutes)) return '';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        const parseTime = (timeStr) => {
            if (!timeStr) return null;
            const [h, m] = timeStr.split(':').map(Number);
            if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) return null;
            return (h * 60) + m; // Total minutes
        };

        const calculateTotalMinutes = (dayEntry) => {
            let total = 0;
            // AM
            const amStart = parseTime(dayEntry.amStart);
            const amEnd = parseTime(dayEntry.amEnd);
            if (amStart !== null && amEnd !== null && amEnd > amStart) {
                total += (amEnd - amStart);
            }
            // PM
            const pmStart = parseTime(dayEntry.pmStart);
            const pmEnd = parseTime(dayEntry.pmEnd);
            if (pmStart !== null && pmEnd !== null && pmEnd > pmStart) {
                total += (pmEnd - pmStart);
            }
            return total;
        };

        const hoursToMinutes = (hours) => hours * 60;
        const minutesToHours = (minutes) => minutes / 60;
        
        // --- DATA ACCESS (Firestore) ---

        const getEmployeeDocRef = (employeeId) => doc(db, 'admin_roster', employeeId);
        const getTimesheetDocRef = (employeeId, weekId) => doc(db, 'timesheets', `${employeeId}-${weekId}`);

        const getEmployeeData = async (employeeId) => {
            if (!db) return null;
            try {
                const docSnap = await getDoc(getEmployeeDocRef(employeeId));
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                }
            } catch (error) {
                console.error("Error fetching employee data:", error);
            }
            return null;
        };

        const saveEmployeeData = async (employeeData) => {
            if (!db) return;
            const { id, ...data } = employeeData;
            try {
                await setDoc(getEmployeeDocRef(id), data);
                console.log("Employee data saved successfully.");
                return true;
            } catch (error) {
                console.error("Error saving employee data:", error);
                return false;
            }
        };

        const deleteEmployeeData = async (employeeId) => {
            if (!db || employeeId === 'A9999') return false; // Prevent admin deletion
            try {
                await deleteDoc(getEmployeeDocRef(employeeId));
                console.log(`Employee ${employeeId} deleted.`);
                return true;
            } catch (error) {
                console.error("Error deleting employee data:", error);
                return false;
            }
        };

        const getTimesheetData = async (employeeId) => {
            if (!db) return null;
            const weekId = getWeekId();
            const docRef = getTimesheetDocRef(employeeId, weekId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                }
            } catch (error) {
                console.error("Error fetching timesheet data:", error);
            }
            return createEmptyTimesheet(employeeId, weekId);
        };
        
        const saveTimesheetData = async (timesheet) => {
            if (!db || !timesheet.employeeId) return false;
            const docRef = getTimesheetDocRef(timesheet.employeeId, timesheet.weekId);
            try {
                await setDoc(docRef, timesheet);
                return true;
            } catch (error) {
                console.error("Error saving timesheet data:", error);
                return false;
            }
        };

        const createEmptyTimesheet = (employeeId, weekId) => {
            const days = {};
            DAYS_OF_WEEK.forEach(day => {
                days[day] = { amStart: '', amEnd: '', pmStart: '', pmEnd: '' };
            });
            return {
                employeeId,
                weekId,
                submitted: false,
                submissionDate: null,
                times: days,
                totalMinutesSubmitted: 0
            };
        };

        // --- MAIN APPLICATION LOGIC ---

        const calculateAndGetTotals = (timesheet, contractHours) => {
            let totalMinutesSubmitted = 0;
            Object.values(timesheet.times).forEach(day => {
                totalMinutesSubmitted += calculateTotalMinutes(day);
            });
            
            const hoursSubmitted = minutesToHours(totalMinutesSubmitted);
            const contractMinutes = hoursToMinutes(contractHours);
            const paidMinutes = Math.max(totalMinutesSubmitted, contractMinutes);
            
            return {
                totalMinutesSubmitted: totalMinutesSubmitted,
                hoursSubmitted: hoursSubmitted,
                paidHours: minutesToHours(paidMinutes),
            };
        };

        const handleLogin = async () => {
            if (!isAppReady) return;

            const staffNumber = document.getElementById('staffNumber').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const loginFeedback = document.getElementById('loginFeedback');
            loginFeedback.textContent = '';
            
            if (!staffNumber || !lastName) {
                loginFeedback.textContent = "Please enter both Staff Number and Last Name.";
                return;
            }

            // 1. Fetch employee data
            const employee = await getEmployeeData(staffNumber);

            if (!employee) {
                loginFeedback.textContent = `Login failed: Staff Number "${staffNumber}" not found in system.`;
                return;
            }

            // 2. Simple surname verification (case-insensitive check against the last word of fullName)
            const employeeLastName = employee.fullName.split(' ').pop();
            if (lastName.toLowerCase() !== employeeLastName.toLowerCase()) {
                loginFeedback.textContent = "Login failed: Staff Number and Last Name combination is incorrect.";
                return;
            }

            // 3. Login successful
            currentEmployee = employee;
            if (currentEmployee.isAdmin) {
                renderAdminView();
            } else {
                renderTimesheetView();
            }
        };

        // --- RENDER FUNCTIONS ---

        const renderLoginView = (message = '') => {
            document.getElementById('app').innerHTML = `
                <div class="max-w-md mx-auto p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 text-center">Staff Timesheet Login</h1>
                    <div id="loginFeedback" class="text-sm text-red-600 mb-4 font-semibold">${message}</div>
                    
                    <div class="mb-4">
                        <label for="staffNumber" class="block text-sm font-medium text-gray-700 mb-1">Staff Number (or Employee ID)</label>
                        <input type="text" id="staffNumber" placeholder="S12345" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    
                    <div class="mb-6">
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name (for verification)</label>
                        <input type="text" id="lastName" placeholder="Smith" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>

                    <button id="loginButton" class="w-full py-3 px-4 rounded-lg text-white font-bold transition duration-300 shadow-md">
                        ${isAppReady ? 'Access Timesheet' : 'Connecting to Cloud...'}
                    </button>
                </div>
            `;

            const loginButton = document.getElementById('loginButton');
            if (isAppReady) {
                loginButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                loginButton.disabled = false;
                loginButton.onclick = handleLogin;
            } else {
                loginButton.classList.add('bg-gray-400');
                loginButton.disabled = true;
            }
            
            document.getElementById('staffNumber')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('lastName')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        };

        const renderSignOutButton = () => {
            return `
                <button onclick="handleSignOut()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-150 shadow-sm ml-4">
                    Sign Out
                </button>
            `;
        };

        window.handleSignOut = () => {
            currentEmployee = null;
            renderLoginView();
        };

        // --- TIMESHEET VIEW (STAFF) ---

        const handleTimeInput = async (day, period, type, event) => {
            let timesheet = await getTimesheetData(currentEmployee.id);
            if (timesheet.submitted) return; 

            timesheet.times[day][`${period}${type}`] = event.target.value;
            
            // Recalculate totals and update the document
            const totals = calculateAndGetTotals(timesheet, currentEmployee.contractHours);
            timesheet.totalMinutesSubmitted = totals.totalMinutesSubmitted;

            await saveTimesheetData(timesheet);
        };

        const handleTimesheetSubmit = async () => {
            const weekId = getWeekId();
            const docRef = getTimesheetDocRef(currentEmployee.id, weekId);
            
            // Use a transaction to ensure atomic update (important for shared data)
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists) {
                        throw "Timesheet does not exist for submission.";
                    }
                    const timesheet = docSnap.data();

                    if (timesheet.submitted) {
                        throw "Timesheet already submitted.";
                    }
                    
                    // Final calculation before marking submitted
                    const totals = calculateAndGetTotals(timesheet, currentEmployee.contractHours);
                    
                    transaction.update(docRef, {
                        submitted: true,
                        submissionDate: new Date().toISOString(),
                        totalMinutesSubmitted: totals.totalMinutesSubmitted // Ensure final total is saved
                    });
                    
                    // Trigger email (mailto link)
                    const emailBody = `
                        Timesheet Submission Report:
                        Employee: ${currentEmployee.fullName} (${currentEmployee.id})
                        Week Starting: ${weekId}
                        Total Hours Submitted: ${totals.hoursSubmitted.toFixed(2)}
                        Contract Hours: ${currentEmployee.contractHours.toFixed(2)}
                        Total PAID Hours: ${totals.paidHours.toFixed(2)}

                        Please see the timesheet system for detailed entry times.
                    `;
                    
                    const mailtoLink = `mailto:timesheet_admin@yourcompany.com?subject=Timesheet Submission for ${currentEmployee.fullName} (${weekId})&body=${encodeURIComponent(emailBody.trim())}`;
                    
                    // Safely trigger mailto to prevent mobile environment crash
                    const a = document.createElement('a');
                    a.href = mailtoLink;
                    a.target = '_blank'; 
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                
                // Refresh the view after transaction success
                renderTimesheetView("Submission successful! Email draft opened.");

            } catch (error) {
                console.error("Submission failed:", error);
                const message = (typeof error === 'string') ? error : "An error occurred during submission.";
                renderTimesheetView(message);
            }
        };

        const handleTimesheetRecall = async () => {
            const weekId = getWeekId();
            const docRef = getTimesheetDocRef(currentEmployee.id, weekId);
            
            if (confirm("Are you sure you want to recall this submission? You will be able to edit and re-submit.")) {
                try {
                    await setDoc(docRef, { submitted: false, submissionDate: null }, { merge: true });
                    renderTimesheetView("Submission recalled. You may now edit your hours.");
                } catch (error) {
                    console.error("Recall failed:", error);
                    renderTimesheetView("Error recalling submission.");
                }
            }
        };

        const renderTimesheetView = async (message = '') => {
            let timesheet = await getTimesheetData(currentEmployee.id);
            const { hoursSubmitted, paidHours } = calculateAndGetTotals(timesheet, currentEmployee.contractHours);
            const isSubmitted = timesheet.submitted;
            const weekId = getWeekId();
            
            const timesheetRows = DAYS_OF_WEEK.map(day => {
                const dayData = timesheet.times[day] || { amStart: '', amEnd: '', pmStart: '', pmEnd: '' };
                const dayTotalMinutes = calculateTotalMinutes(dayData);
                const dayTotalHours = minutesToHours(dayTotalMinutes).toFixed(2);
                
                const timeInput = (period, type, value) => `
                    <input type="time" value="${value}" 
                           onchange="handleTimeInput('${day}', '${period}', '${type}', event)"
                           ${isSubmitted ? 'disabled' : ''}
                           class="w-full text-center p-1 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ${isSubmitted ? 'bg-gray-100' : 'bg-white'}"
                    >
                `;

                return `
                    <tr class="hover:bg-indigo-50 transition duration-100 border-b">
                        <td class="font-semibold px-4 py-2 text-indigo-700">${day}</td>
                        <td class="p-2">${timeInput('am', 'Start', dayData.amStart)}</td>
                        <td class="p-2">${timeInput('am', 'End', dayData.amEnd)}</td>
                        <td class="p-2">${timeInput('pm', 'Start', dayData.pmStart)}</td>
                        <td class="p-2">${timeInput('pm', 'End', dayData.pmEnd)}</td>
                        <td class="text-center font-bold text-gray-800 px-4">${dayTotalHours}</td>
                    </tr>
                `;
            }).join('');

            const submissionControls = isSubmitted ? 
                `<div class="flex items-center space-x-4">
                    <span class="text-lg font-bold text-green-600">‚úÖ Submitted</span>
                    <button onclick="handleTimesheetRecall()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                        Recall Submission
                    </button>
                </div>` : 
                `<button onclick="handleTimesheetSubmit()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Submit Final Hours
                </button>`;

            document.getElementById('app').innerHTML = `
                <div class="space-y-6">
                    <header class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <h1 class="text-3xl font-extrabold text-indigo-700">Timesheet for ${currentEmployee.fullName}</h1>
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600">Contract: ${currentEmployee.contractHours.toFixed(1)} hrs</span>
                            ${renderSignOutButton()}
                        </div>
                    </header>
                    
                    ${message ? `<div class="bg-blue-100 text-blue-800 p-3 rounded-lg font-medium">${message}</div>` : ''}

                    <p class="text-gray-500 font-medium">Week Starting: ${weekId}</p>

                    <div class="overflow-x-auto rounded-lg shadow-md border border-gray-300">
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-indigo-50 border-b border-gray-300">
                                <tr class="text-left text-gray-700">
                                    <th class="px-4 py-3">Day</th>
                                    <th class="p-3">AM Start</th>
                                    <th class="p-3">AM End</th>
                                    <th class="p-3">PM Start</th>
                                    <th class="p-3">PM End</th>
                                    <th class="px-4 py-3 text-center">Daily Total (H)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${timesheetRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 p-4 bg-indigo-50 rounded-lg shadow-inner">
                        <div class="text-lg font-semibold text-gray-800">
                            Total Submitted Hours: <span class="text-indigo-700">${hoursSubmitted.toFixed(2)}</span>
                        </div>
                        <div class="text-xl font-extrabold text-green-700 bg-green-100 p-2 rounded-lg">
                            Total PAID Hours: ${paidHours.toFixed(2)}
                        </div>
                        <div>
                            ${submissionControls}
                        </div>
                    </div>
                </div>
            `;
            
            // Re-attach global functions for inline HTML
            window.handleTimeInput = handleTimeInput;
            window.handleTimesheetSubmit = handleTimesheetSubmit;
            window.handleTimesheetRecall = handleTimesheetRecall;
        };

        // --- ADMIN VIEW ---

        const renderTimesheetDetail = (employeeId, timesheet) => {
            const detailRows = DAYS_OF_WEEK.map(day => {
                const dayData = timesheet.times[day] || {};
                const dayTotalMinutes = calculateTotalMinutes(dayData);
                const dayTotalHours = minutesToHours(dayTotalMinutes).toFixed(2);
                
                return `
                    <tr class="border-b hover:bg-yellow-50">
                        <td class="font-medium text-gray-700 px-4 py-2">${day}</td>
                        <td class="px-4 py-2">${dayData.amStart || '-'}</td>
                        <td class="px-4 py-2">${dayData.amEnd || '-'}</td>
                        <td class="px-4 py-2">${dayData.pmStart || '-'}</td>
                        <td class="px-4 py-2">${dayData.pmEnd || '-'}</td>
                        <td class="px-4 py-2 font-bold">${dayTotalHours}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div id="detailView" class="mt-8 p-4 bg-white rounded-lg shadow-inner border border-yellow-300">
                    <h3 class="text-xl font-bold text-yellow-700 mb-4 border-b pb-2">Detailed Entries for ${currentEmployeeDetail.fullName}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-yellow-100">
                                <tr>
                                    <th class="text-left px-4 py-2">Day</th>
                                    <th class="text-left px-4 py-2">AM Start</th>
                                    <th class="text-left px-4 py-2">AM End</th>
                                    <th class="text-left px-4 py-2">PM Start</th>
                                    <th class="text-left px-4 py-2">PM End</th>
                                    <th class="text-left px-4 py-2">Hours Logged</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detailRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        let currentEmployeeDetail = null;

        const showEmployeeDetails = async (employeeId, employeeName) => {
            currentEmployeeDetail = await getEmployeeData(employeeId); // Used for detail header
            const timesheet = await getTimesheetData(employeeId);
            const detailHtml = renderTimesheetDetail(employeeId, timesheet);
            
            // Target the existing detail container in the admin view
            const detailContainer = document.getElementById('employeeDetailContainer');
            if (detailContainer) {
                detailContainer.innerHTML = detailHtml;
                // Scroll down to the detail view
                detailContainer.scrollIntoView({ behavior: 'smooth' });
            }
        };

        const renderAdminView = () => {
            document.getElementById('app').innerHTML = `
                <div class="space-y-8">
                    <header class="flex justify-between items-center pb-4 border-b border-indigo-200">
                        <h1 class="text-3xl font-extrabold text-indigo-700">Admin Dashboard</h1>
                        ${renderSignOutButton()}
                    </header>

                    <!-- Employee Management -->
                    <section class="p-6 bg-indigo-50 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-2xl font-bold text-indigo-800 mb-4">1. Employee Management</h2>
                        <div id="employeeForm"></div>
                        <div id="userList" class="mt-6"></div>
                    </section>
                    
                    <!-- Timesheet Summary -->
                    <section class="p-6 bg-white rounded-xl shadow-lg border border-gray-300">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">2. Weekly Timesheet Summary (${getWeekId()})</h2>
                        <div id="summaryTableContainer">Loading timesheet summary...</div>
                    </section>

                    <!-- Employee Detail View -->
                    <div id="employeeDetailContainer">
                        <!-- Detailed entries will load here after clicking an employee name -->
                    </div>
                </div>
            `;
            renderEmployeeForm();
            fetchAndRenderSummary();
            
            // Re-attach global functions for inline HTML
            window.showEmployeeDetails = showEmployeeDetails;
            window.handleDeleteEmployee = handleDeleteEmployee;
            window.handleAdminFormSubmit = handleAdminFormSubmit;
        };
        
        // --- ADMIN SUB-RENDERS & HANDLERS ---
        
        const renderEmployeeForm = (employee = {}) => {
            const isEditing = !!employee.id;
            const formHtml = `
                <form id="adminForm" class="space-y-4">
                    <div>
                        <label for="adminId" class="block text-sm font-medium text-gray-700">Staff Number (ID)</label>
                        <input type="text" id="adminId" value="${employee.id || ''}" ${isEditing ? 'readonly' : ''} placeholder="E1004" class="w-full px-3 py-2 border rounded-lg ${isEditing ? 'bg-gray-100' : 'border-gray-300'}">
                        ${isEditing ? `<p class="text-xs text-red-500 mt-1">ID cannot be changed when editing.</p>` : ''}
                    </div>
                    <div>
                        <label for="adminName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="adminName" value="${employee.fullName || ''}" placeholder="Sarah Davis" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="adminContract" class="block text-sm font-medium text-gray-700">Contract Hours (Minimum weekly pay)</label>
                        <input type="number" id="adminContract" value="${employee.contractHours || 0}" min="0" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-150">
                        ${isEditing ? 'Update Employee' : 'Add New Employee'}
                    </button>
                    ${isEditing ? `<button type="button" onclick="renderEmployeeForm({})" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition duration-150">
                        Cancel Edit / Add New
                    </button>` : ''}
                </form>
            `;
            document.getElementById('employeeForm').innerHTML = formHtml;
            document.getElementById('adminForm').onsubmit = (e) => {
                e.preventDefault();
                handleAdminFormSubmit(isEditing ? employee.id : null);
            };
        };
        
        const handleAdminFormSubmit = async (employeeIdToEdit) => {
            const id = (employeeIdToEdit || document.getElementById('adminId').value.trim()).toUpperCase();
            const fullName = document.getElementById('adminName').value.trim();
            const contractHours = parseFloat(document.getElementById('adminContract').value);

            if (!id || !fullName || isNaN(contractHours)) {
                alert("Please fill out all fields correctly.");
                return;
            }
            if (id === 'A9999' && contractHours !== 0) {
                 if (!confirm("Warning: Changing the A9999 contract hours is unusual. Are you sure you want to proceed?")) return;
            }

            const employeeData = {
                id: id,
                fullName: fullName,
                contractHours: contractHours,
                isAdmin: id === 'A9999',
            };

            const success = await saveEmployeeData(employeeData);
            if (success) {
                renderEmployeeForm({}); // Reset form
                fetchAndRenderUserList();
            }
        };

        const handleDeleteEmployee = async (employeeId, employeeName) => {
            if (employeeId === 'A9999') {
                alert("The System Administrator (A9999) cannot be deleted.");
                return;
            }
            if (confirm(`Are you sure you want to permanently delete the contract for ${employeeName} (${employeeId})? This cannot be undone.`)) {
                const success = await deleteEmployeeData(employeeId);
                if (success) {
                    fetchAndRenderUserList();
                    // Clear detail view if deleted employee was being viewed
                    const detailContainer = document.getElementById('employeeDetailContainer');
                    if (detailContainer && currentEmployeeDetail && currentEmployeeDetail.id === employeeId) {
                        detailContainer.innerHTML = '';
                        currentEmployeeDetail = null;
                    }
                }
            }
        };

        const fetchAndRenderUserList = async () => {
            if (!db) return;
            const rosterCol = collection(db, 'admin_roster');
            try {
                const q = query(rosterCol);
                const snapshot = await getDocs(q);
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const userListHtml = users.sort((a, b) => a.id.localeCompare(b.id)).map(user => {
                    const deleteButton = user.id !== 'A9999' ? 
                        `<button onclick="handleDeleteEmployee('${user.id}', '${user.fullName}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg transition duration-150">Delete</button>` : 
                        `<span class="text-gray-400 text-xs font-semibold py-1 px-3">Admin</span>`;

                    const editButton = user.id !== 'A9999' ? 
                         `<button onclick='renderEmployeeForm(${JSON.stringify(user)})' class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1 px-3 rounded-lg transition duration-150 mr-2">Edit</button>` : '';

                    return `
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                            <span class="font-medium">${user.id} - ${user.fullName} </span>
                            <span class="text-sm text-gray-500">Contract: ${user.contractHours.toFixed(1)} hrs</span>
                            <div class="flex items-center">
                                ${editButton}
                                ${deleteButton}
                            </div>
                        </li>
                    `;
                }).join('');

                document.getElementById('userList').innerHTML = `<ul class="space-y-3">${userListHtml}</ul>`;
            } catch (error) {
                document.getElementById('userList').innerHTML = `<p class="text-red-500">Error loading user list: ${error.message}</p>`;
                console.error("Error fetching user list:", error);
            }
        };

        const fetchAndRenderSummary = async () => {
            if (!db) return;
            const rosterCol = collection(db, 'admin_roster');
            const timesheetCol = collection(db, 'timesheets');
            const weekId = getWeekId();
            const container = document.getElementById('summaryTableContainer');
            
            if (!container) return;
            container.innerHTML = 'Fetching data...';

            try {
                // 1. Get all employees (Roster)
                const rosterSnapshot = await getDocs(rosterCol);
                const roster = rosterSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(e => !e.isAdmin);
                
                // 2. Fetch Timesheet data for the current week for all employees
                const timesheetPromises = roster.map(employee => getTimesheetData(employee.id));
                const timesheets = await Promise.all(timesheetPromises);
                
                const summaryData = roster.map((employee, index) => {
                    const timesheet = timesheets[index] || createEmptyTimesheet(employee.id, weekId);
                    const totals = calculateAndGetTotals(timesheet, employee.contractHours);
                    
                    return {
                        ...employee,
                        hoursSubmitted: totals.hoursSubmitted,
                        paidHours: totals.paidHours,
                        isSubmitted: timesheet.submitted,
                    };
                });

                const summaryRows = summaryData.map(data => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 text-indigo-700 font-medium cursor-pointer hover:underline" onclick="showEmployeeDetails('${data.id}', '${data.fullName}')">
                            ${data.id} - ${data.fullName}
                        </td>
                        <td class="px-4 py-3 text-center">${data.contractHours.toFixed(1)}</td>
                        <td class="px-4 py-3 text-center font-bold">${data.hoursSubmitted.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center font-extrabold text-green-700">${data.paidHours.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${data.isSubmitted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${data.isSubmitted ? 'Submitted' : 'In Progress'}
                            </span>
                        </td>
                    </tr>
                `).join('');

                const summaryTableHtml = `
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-gray-100">
                                <tr class="text-left text-gray-700">
                                    <th class="px-4 py-3">Employee Name (Click for Detail)</th>
                                    <th class="px-4 py-3 text-center">Contract (Hrs)</th>
                                    <th class="px-4 py-3 text-center">Submitted (Hrs)</th>
                                    <th class="px-4 py-3 text-center">Paid (Hrs)</th>
                                    <th class="px-4 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summaryRows.length > 0 ? summaryRows : '<tr><td colspan="5" class="text-center py-4 text-gray-500">No staff members found in the system.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = summaryTableHtml;
                fetchAndRenderUserList(); // Also update user list in management section

            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Error loading summary: ${error.message}. Ensure Firestore is set up and running.</p>`;
                console.error("Error fetching admin summary:", error);
            }
        };
        
        // --- GLOBAL INITIALIZATION ---

        const initApp = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     throw new Error("Firebase configuration is missing. Please insert your firebaseConfig object.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Sign in securely (either with a provided token or anonymously)
                if (initialAuthToken) {
                     await signInWithCustomToken(auth, initialAuthToken);
                } else {
                     // For public hosting (GitHub Pages), sign in anonymously. 
                     await signInAnonymously(auth);
                }

                currentUserId = auth.currentUser?.uid || 'anonymous';
                isAppReady = true;
                
                // 2. Initial data creation check (for a fresh database)
                const adminDoc = await getEmployeeData('A9999');
                if (!adminDoc) {
                    // These WRITE operations require permission to the 'admin_roster' collection
                    await saveEmployeeData({ id: 'A9999', fullName: 'System Administrator', contractHours: 0, isAdmin: true });
                    await saveEmployeeData({ id: 'E1001', fullName: 'Debbie Abbott', contractHours: 12.5, isAdmin: false });
                    await saveEmployeeData({ id: 'E1002', fullName: 'Bob Smith', contractHours: 20.0, isAdmin: false });
                    await saveEmployeeData({ id: 'E1003', fullName: 'Charlie Brown', contractHours: 0.0, isAdmin: false });
                }

            } catch (error) {
                console.error("Critical Firebase Initialization Error:", error);

                let instruction = `
                    <div class="p-4 bg-red-100 rounded-lg border border-red-400">
                        <h2 class="text-xl font-bold text-red-800">Critical Cloud Connection Error!</h2>
                        <p class="mt-2 text-red-700">The application failed to connect to your live Firebase database or permission was denied. This is almost certainly due to **incorrect Firebase Configuration** or **incorrect Firestore Security Rules**.</p>
                        <h3 class="mt-3 text-lg font-semibold text-red-800">üõ†Ô∏è Action Checklist:</h3>
                        <ol class="list-decimal list-inside mt-2 space-y-2 text-sm text-red-700">
                            <li><strong>Configuration Check:</strong> Ensure your <code>firebaseConfig</code> object (starting on line 35 of the code) is correctly pasted with no missing commas, quotes, or curly braces.</li>
                            <li><strong>Security Rule Fix:</strong> If the config is correct, you MUST update your Firestore Rules to the temporary setup rule to allow the app to write initial data (check the chat history for the exact rule to paste into your Firebase Console).</li>
                        </ol>
                        <p class="mt-3 font-semibold text-red-800">The page will only load when the connection succeeds.</p>
                    </div>
                `;

                renderLoginView(instruction);
                return;
            }

            // Render the initial login view once everything is ready
            renderLoginView();
        };

        // Start the initialization process
        initApp();

    </script>
</body>
</html>
